Parts of this code was borrowed from mmm-mako mode. (Thanks Philip Jenvey)
