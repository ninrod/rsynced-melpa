The code below is heavily based on markdown-mode and AUCTeX.
